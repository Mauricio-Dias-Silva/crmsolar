{% extends 'solar/base.html' %}
{% load widget_tweaks %}

{% block title %}{{ title }}{% endblock %}

{% block extra_css %}
<style>
    .section-header {
        font-weight: 600;
        color: #333;
        border-bottom: 2px solid #0d6efd;
        padding-bottom: 5px;
        margin: 25px 0 15px 0;
    }
    .item-form-row {
        display: flex;
        gap: 10px;
        align-items: flex-start;
        margin-bottom: 15px;
        padding-bottom: 15px;
        border-bottom: 1px solid #eee;
    }
    .item-form-row:last-of-type {
        border-bottom: none;
    }
    .delete-checkbox-label {
        margin-top: 30px; /* Alinha o checkbox 'Remover' com os inputs */
        display: block;
        white-space: nowrap;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
            <h4 class="mb-0">{{ title }}</h4>
        </div>
        <div class="card-body">
            
            <form method="POST" enctype="multipart/form-data" novalidate id="projeto-form">
                {% csrf_token %}
                
                <div class="section-header">Detalhes Gerais do Projeto</div>
                <div class="card mb-4 shadow-sm">
                    <div class="card-body">
                        <div class="row">
                            {% for field in form %}
                            <div class="col-md-6 mb-3">
                                <label for="{{ field.id_for_label }}" class="form-label">{{ field.label }}</label>
                                {% if 'Select' in field.field.widget.template_name %}
                                    {{ field|add_class:"form-select" }}
                                {% else %}
                                    {{ field|add_class:"form-control" }}
                                {% endif %}
                                {% for error in field.errors %}
                                    <div class="invalid-feedback d-block">{{ error }}</div>
                                {% endfor %}
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <div class="section-header">Or√ßamento Detalhado</div>
                <div class="card mb-4 shadow-sm">
                    <div class="card-body">
                        
                        {{ formset.management_form }}
                        
                        <div id="item-form-list">
                            {% for item_form in formset %}
                            <div class="item-form-row">
                                <div style="flex-grow: 1;">{{ item_form.descricao }}</div>
                                <div style="width: 100px;">{{ item_form.unidade }}</div>
                                <div style="width: 100px;">{{ item_form.quantidade }}</div>
                                <div style="width: 150px;">{{ item_form.valor_unitario }}</div>
                                <div class="delete-checkbox-label">
                                    {% if item_form.instance.pk and formset.can_delete %}
                                        {{ item_form.DELETE }} <label for="{{ item_form.DELETE.id_for_label }}">Remover</label>
                                    {% endif %}
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        
                        <div id="empty-form" class="d-none">
                            <div class="item-form-row">
                                <div style="flex-grow: 1;">{{ formset.empty_form.descricao }}</div>
                                <div style="width: 100px;">{{ formset.empty_form.unidade }}</div>
                                <div style="width: 100px;">{{ formset.empty_form.quantidade }}</div>
                                <div style="width: 150px;">{{ formset.empty_form.valor_unitario }}</div>
                                <div class="delete-checkbox-label"></div>
                            </div>
                        </div>

                        <button type="button" id="add-item-btn" class="btn btn-success mt-2">
                            <i class="fas fa-plus"></i> Adicionar Item ao Or√ßamento
                        </button>
                    </div>
                </div>
                
                <div class="d-flex justify-content-between mt-4">
                    <button type="submit" class="btn btn-primary btn-lg">
                        <i class="fas fa-save"></i> Salvar Projeto
                    </button>
                    <a href="{% if form.instance.pk %}{% url 'crm:detalhe_projeto' form.instance.pk %}{% else %}{% url 'crm:lista_projetos' %}{% endif %}" class="btn btn-secondary btn-lg">
                        Cancelar
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// üí° SCRIPT FINAL E CORRIGIDO
document.addEventListener('DOMContentLoaded', function() {
    const addItemButton = document.getElementById('add-item-btn');
    const formList = document.getElementById('item-form-list');
    const emptyFormTemplateHTML = document.getElementById('empty-form').innerHTML;
    
    addItemButton.addEventListener('click', function() {
        // Pega o total de forms ATUAL
        const totalFormsInput = document.getElementById('id_itens_proposta-TOTAL_FORMS');
        const formIndex = parseInt(totalFormsInput.value);
        
        // Cria o HTML do novo formul√°rio substituindo o prefixo pelo √≠ndice correto
        const newFormHtml = emptyFormTemplateHTML.replace(/__prefix__/g, formIndex);
        
        // Cria um novo elemento div, insere o HTML e adiciona √† lista
        const newFormElement = document.createElement('div');
        newFormElement.innerHTML = newFormHtml;
        formList.appendChild(newFormElement.firstElementChild);
        
        // Incrementa o total de forms
        totalFormsInput.value = formIndex + 1;
    });
});
</script>

{% endblock %}

