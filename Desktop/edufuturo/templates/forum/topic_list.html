{% extends "base.html" %}

{% block content %}
<nav aria-label="breadcrumb">
  <ol class="breadcrumb">
    <li class="breadcrumb-item"><a href="/">Cursos</a></li>
    <li class="breadcrumb-item"><a href="{% url 'courses:course_detail' lesson.module.course.id %}">{{ lesson.module.course.name }}</a></li>
    <li class="breadcrumb-item"><a href="{% url 'courses:lesson_detail' lesson.id %}">{{ lesson.title }}</a></li>
    <li class="breadcrumb-item active">Fórum</li>
  </ol>
</nav>

<h2>Fórum da Aula: {{ lesson.title }}</h2>

<!-- Novo Tópico -->
<div class="card mb-4">
  <div class="card-body">
    <h5>Novo Tópico</h5>
    <form method="post">
      {% csrf_token %}
      {{ form.title }}
      {{ form.content }}
      <button type="submit" class="btn btn-primary btn-sm mt-2">Publicar</button>
    </form>
  </div>
</div>

<!-- Lista de Tópicos -->
{% for topic in topics %}
<div class="card mb-4">
  <div class="card-body">
    <h5>{{ topic.title }}</h5>
    <p class="text-muted small">
      Por {{ topic.author.get_full_name|default:topic.author.username }} 
      em {{ topic.created_at|date:"d/m/Y H:i" }}
    </p>
    <p>{{ topic.content }}</p>

    <!-- Comentários -->
    {% for comment in topic.comments.all %}
      {% if not comment.parent %}
        {% include "forum/_comment.html" with comment=comment topic=topic %}
      {% endif %}
    {% endfor %}

    <!-- Responder ao tópico -->
    <form method="post" action="{% url 'forum:add_comment' topic.id %}" class="mt-3">
      {% csrf_token %}
      <div class="input-group">
        <input type="text" name="content" class="form-control form-control-sm" placeholder="Responder...">
        <button class="btn btn-outline-secondary btn-sm" type="submit">Enviar</button>
      </div>
    </form>
  </div>
</div>
{% empty %}
<p>Nenhum tópico ainda. Seja o primeiro a perguntar!</p>
{% endfor %}
{% endblock %}

{% block extra_js %}
<script>
function upvote(commentId) {
  fetch(`/forum/curtir/${commentId}/`, { method: 'POST', headers: {'X-CSRFToken': '{{ csrf_token }}'} })
  .then(r => r.json())
  .then(data => {
    document.getElementById(`likes-${commentId}`).textContent = data.likes;
    const btn = document.getElementById(`upvote-btn-${commentId}`);
    btn.classList.toggle('text-primary');
    btn.classList.toggle('bi-hand-thumbs-up');
    btn.classList.toggle('bi-hand-thumbs-up-fill');
  });
}
</script>
{% endblock %}