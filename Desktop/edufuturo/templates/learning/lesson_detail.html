{% extends "base.html" %}

{% block content %}
<nav aria-label="breadcrumb">
  <ol class="breadcrumb">
    <li class="breadcrumb-item"><a href="/">Cursos</a></li>
    <li class="breadcrumb-item"><a href="{% url 'course_detail' lesson.module.course.id %}">{{ lesson.module.course.name }}</a></li>
    <li class="breadcrumb-item active" aria-current="page">{{ lesson.title }}</li>
  </ol>
</nav>

<h1>{{ lesson.title }}</h1>

<!-- Em lesson_detail.html -->
{% if user.is_authenticated and user.student_profile in lesson.module.course.enrolled_students.all %}
  <iframe src="{{ lesson.video_url }}" ...></iframe>
{% else %}
  <div class="alert alert-warning">Você precisa estar matriculado neste curso para assistir.</div>
{% endif %}

<div class="bg-light p-3 rounded mb-4">
  {{ lesson.content|linebreaks }}
</div>

{% if lesson.materials.all %}
<h5>Materiais de Apoio</h5>
<ul>
  {% for material in lesson.materials.all %}
  <li><a href="{{ material.file.url }}" target="_blank">{{ material.title }}</a> ({{ material.file.size|filesizeformat }})</li>
  {% endfor %}
</ul>
{% endif %}

{% if progress %}
  {% if progress.completed %}
    <button class="btn btn-success btn-sm" disabled>
      <i class="bi bi-check-circle"></i> Concluído
    </button>
  {% else %}
    <form method="post" action="{% url 'learning:mark_complete' lesson.id %}" class="mt-3">
      {% csrf_token %}
      <button type="submit" class="btn btn-primary btn-sm">
        <i class="bi bi-check-circle"></i> Marcar como Concluída
      </button>
    </form>
  {% endif %}
{% endif %}

{% if lesson.get_embed_url %}
<div class="ratio ratio-16x9 mb-4">
  <iframe 
    src="{{ lesson.get_embed_url }}?rel=0&modestbranding=1" 
    title="{{ lesson.title }}"
    allowfullscreen
    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture">
  </iframe>
</div>
{% endif %}

<a href="{% url 'course_detail' lesson.module.course.id %}" class="btn btn-outline-secondary btn-sm">&larr; Voltar ao curso</a>
{% endblock %}